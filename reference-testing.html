<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="自省和扩展 Trio" href="reference-lowlevel.html" /><link rel="prev" title="信号" href="ref-io/signals.html" />

    <link rel="shortcut icon" href="_static/favicon-32.png"/><!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Trio 中的测试 - Trio 0.27.0+dev 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-codeautolink.css?v=125d5c1c" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/hackrtd.css?v=2d9fc201" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Trio 0.27.0+dev 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/wordmark-transparent.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Trio 0.27.0+dev 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Trio 友好且全面的手册：</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">教程</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome-trio-libraries.html">超棒的 Trio 库</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="ref-core/index.html">Trio 的核心功能</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Trio 的核心功能</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="ref-core/run.html">运行 Trio</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/general_principles.html">一般原则</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/time_clock.html">时间和时钟</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/cancel_timeout.html">取消和超时</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/tasks.html">任务</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/task_local_storeage.html">任务存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/task_sync.html">任务同步和通信</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/note_async_generator.html">异步生成器注意事项</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/threads.html">线程（如果必须）</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/debugging.html">交互式调试</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-core/exc_warn.html">异常和警告</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="ref-io/index.html">Trio 中的 I/O</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Trio 中的 I/O</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="ref-io/abs_api.html">抽象流 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-io/low_level.html">使用 <code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.socket</span></code> 进行低级网络编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-io/async_file_io.html">异步文件系统 I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-io/subprocess.html">生成子进程</a></li>
<li class="toctree-l2"><a class="reference internal" href="ref-io/signals.html">信号</a></li>
</ul>
</li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Trio 中的测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference-lowlevel.html">自省和扩展 Trio</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">设计和内部结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">发布历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为 Trio 及相关项目做出贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="releasing.html">准备发布</a></li>
<li class="toctree-l1"><a class="reference internal" href="code-of-conduct.html">行为守则</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/hellowac/trio-zh-cn/blob/sync-docs/cn_docs/source/reference-testing.rst?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/hellowac/trio-zh-cn/edit/sync-docs/cn_docs/source/reference-testing.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="trio">
<h1>Trio 中的测试<a class="headerlink" href="#trio" title="Link to this heading">¶</a></h1>
<p><strong>Testing made easier with</strong> <code class="docutils literal notranslate"><span class="pre">trio.testing</span></code></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="#module-trio.testing" title="trio.testing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.testing</span></code></a> 模块提供了各种工具，帮助更轻松地测试 Trio 代码。与 <a class="reference internal" href="ref-core/time_clock.html#module-trio" title="trio"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio</span></code></a> 命名空间中的其他子模块不同， <a class="reference internal" href="#module-trio.testing" title="trio.testing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.testing</span></code></a> 在执行 <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">trio</span></code> 时 <em>不会</em> 自动导入；你必须显式地执行 <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">trio.testing</span></code>。</p>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="#module-trio.testing" title="trio.testing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.testing</span></code></a> module provides various utilities to make it
easier to test Trio code. Unlike the other submodules in the
<a class="reference internal" href="ref-core/time_clock.html#module-trio" title="trio"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio</span></code></a> namespace, <a class="reference internal" href="#module-trio.testing" title="trio.testing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.testing</span></code></a> is <em>not</em> automatically
imported when you do <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">trio</span></code>; you must <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">trio.testing</span></code>
explicitly.</p>
</div>
</div>
<section id="id1">
<h2>测试工具集成<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p><strong>Test harness integration</strong></p>
<dl class="py decorator">
<dt class="sig sig-object py" id="trio.testing.trio_test">
<span class="sig-prename descclassname"><span class="pre">&#64;</span></span><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">trio_test</span></span><a class="headerlink" href="#trio.testing.trio_test" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

</section>
<section id="testing-time">
<span id="id2"></span><h2>时间和超时<a class="headerlink" href="#testing-time" title="Link to this heading">¶</a></h2>
<p><strong>Time and timeouts</strong></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="#trio.testing.MockClock" title="trio.testing.MockClock"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.testing.MockClock</span></code></a> 是一个 <a class="reference internal" href="ref-core/time_clock.html#trio.abc.Clock" title="trio.abc.Clock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Clock</span></code></a>，它提供了一些技巧，帮助你高效地测试涉及超时的代码：</p>
<ul class="simple">
<li><p>默认情况下，它从时间 0 开始，时钟时间只有在你显式调用 <a class="reference internal" href="#trio.testing.MockClock.jump" title="trio.testing.MockClock.jump"><code class="xref py py-meth docutils literal notranslate"><span class="pre">jump()</span></code></a> 时才会前进。这为测试提供了一个极其可控的时钟。</p></li>
<li><p>如果你希望它像普通时钟一样按真实时间运行，可以将 <a class="reference internal" href="#trio.testing.MockClock.rate" title="trio.testing.MockClock.rate"><code class="xref py py-attr docutils literal notranslate"><span class="pre">rate</span></code></a> 设置为 1.0。你可以在测试中停止或启动时钟。你还可以将 <a class="reference internal" href="#trio.testing.MockClock.rate" title="trio.testing.MockClock.rate"><code class="xref py py-attr docutils literal notranslate"><span class="pre">rate</span></code></a> 设置为 10.0，使时钟时间以 10 倍的真实速度流逝（例如，<code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">trio.sleep(10)</span></code> 会在 1 秒后返回）。</p></li>
<li><p>更有趣的是，你可以将 <a class="reference internal" href="#trio.testing.MockClock.autojump_threshold" title="trio.testing.MockClock.autojump_threshold"><code class="xref py py-attr docutils literal notranslate"><span class="pre">autojump_threshold</span></code></a> 设置为零或一个小值，这样它就会观察运行循环的执行情况，每当所有任务都停下来等待超时时，它会将时钟跳跃到那个超时。 在许多情况下，这使得涉及超时的自然代码能够自动在几乎满负荷的 CPU 使用率下运行，而无需任何更改。（感谢 <a class="reference external" href="https://github.com/majek/fluxcapacitor">fluxcapacitor</a> 提供这个很棒的点子。）</p></li>
<li><p>当然，这些功能可以根据需要任意组合使用。</p></li>
</ul>
<p>尽管有这些技巧，从 Trio &quot;内部&quot; 看，时间的流逝仍然是正常的，只要你限制自己使用 Trio 的时间函数（参见 <a class="reference internal" href="ref-core/time_clock.html#time-and-clocks"><span class="std std-ref">时间和时钟</span></a>）。下面是一个示例，展示了两种让时间快速流逝的不同方式。请注意，在这两种情况下，两个任务保持一致的现实视图，事件按预期顺序发生，尽管它们与真实时间有很大的偏差：</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># across-realtime.py</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">trio</span>
<span class="kn">import</span> <span class="nn">trio.testing</span>

<span class="n">YEAR</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># seconds</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">task1</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task1: sleeping for 1 year&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">YEAR</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task1: woke up; clock says I&#39;ve slept </span><span class="si">{</span><span class="n">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">YEAR</span><span class="si">}</span><span class="s2"> years&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task1: sleeping for 1 year, 100 times&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">YEAR</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task1: slept </span><span class="si">{</span><span class="n">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">YEAR</span><span class="si">}</span><span class="s2"> years total&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">task2</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task2: sleeping for 5 years&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">YEAR</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task2: woke up; clock says I&#39;ve slept </span><span class="si">{</span><span class="n">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">YEAR</span><span class="si">}</span><span class="s2"> years&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task2: sleeping for 500 years&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="n">YEAR</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task2: slept </span><span class="si">{</span><span class="n">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">YEAR</span><span class="si">}</span><span class="s2"> years total&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">trio</span><span class="o">.</span><span class="n">open_nursery</span><span class="p">()</span> <span class="k">as</span> <span class="n">nursery</span><span class="p">:</span>
        <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">task1</span><span class="p">)</span>
        <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">task2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_example</span><span class="p">(</span><span class="n">clock</span><span class="p">):</span>
    <span class="n">real_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">trio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">clock</span><span class="o">=</span><span class="n">clock</span><span class="p">)</span>
    <span class="n">real_duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">real_start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total real time elapsed: </span><span class="si">{</span><span class="n">real_duration</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Clock where time passes at 100 years per second:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">run_example</span><span class="p">(</span><span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">MockClock</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">YEAR</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Clock where time automatically skips past the boring parts:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">run_example</span><span class="p">(</span><span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">MockClock</span><span class="p">(</span><span class="n">autojump_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>输出：</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Clock where time passes at 100 years per second:

task2: sleeping for 5 years
task1: sleeping for 1 year
task1: woke up; clock says I&#39;ve slept 1.0365006048232317 years
task1: sleeping for 1 year, 100 times
task2: woke up; clock says I&#39;ve slept 5.0572111969813704 years
task2: sleeping for 500 years
task1: slept 104.77677842136472 years total
task2: slept 505.25014589075 years total
Total real time elapsed: 5.053582429885864 seconds

Clock where time automatically skips past the boring parts:

task2: sleeping for 5 years
task1: sleeping for 1 year
task1: woke up; clock says I&#39;ve slept 1.0 years
task1: sleeping for 1 year, 100 times
task2: woke up; clock says I&#39;ve slept 5.0 years
task2: sleeping for 500 years
task1: slept 101.0 years total
task2: slept 505.0 years total
Total real time elapsed: 0.019298791885375977 seconds
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="#trio.testing.MockClock" title="trio.testing.MockClock"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.testing.MockClock</span></code></a> is a <a class="reference internal" href="ref-core/time_clock.html#trio.abc.Clock" title="trio.abc.Clock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Clock</span></code></a> with a
few tricks up its sleeve to help you efficiently test code involving
timeouts:</p>
<ul class="simple">
<li><p>By default, it starts at time 0, and clock time only advances when
you explicitly call <a class="reference internal" href="#trio.testing.MockClock.jump" title="trio.testing.MockClock.jump"><code class="xref py py-meth docutils literal notranslate"><span class="pre">jump()</span></code></a>. This provides an
extremely controllable clock for testing.</p></li>
<li><p>You can set <a class="reference internal" href="#trio.testing.MockClock.rate" title="trio.testing.MockClock.rate"><code class="xref py py-attr docutils literal notranslate"><span class="pre">rate</span></code></a> to 1.0 if you want it to start
running in real time like a regular clock. You can stop and start
the clock within a test. You can set <a class="reference internal" href="#trio.testing.MockClock.rate" title="trio.testing.MockClock.rate"><code class="xref py py-attr docutils literal notranslate"><span class="pre">rate</span></code></a> to 10.0
to make clock time pass at 10x real speed (so e.g. <code class="docutils literal notranslate"><span class="pre">await</span>
<span class="pre">trio.sleep(10)</span></code> returns after 1 second).</p></li>
<li><p>But even more interestingly, you can set
<a class="reference internal" href="#trio.testing.MockClock.autojump_threshold" title="trio.testing.MockClock.autojump_threshold"><code class="xref py py-attr docutils literal notranslate"><span class="pre">autojump_threshold</span></code></a> to zero or a small value, and
then it will watch the execution of the run loop, and any time
things have settled down and everyone's waiting for a timeout, it
jumps the clock forward to that timeout. In many cases this allows
natural-looking code involving timeouts to be automatically run at
near full CPU utilization with no changes. (Thanks to <a class="reference external" href="https://github.com/majek/fluxcapacitor">fluxcapacitor</a> for this awesome idea.)</p></li>
<li><p>And of course these can be mixed and matched at will.</p></li>
</ul>
<p>Regardless of these shenanigans, from &quot;inside&quot; Trio the passage of time
still seems normal so long as you restrict yourself to Trio's time
functions (see <a class="reference internal" href="ref-core/time_clock.html#time-and-clocks"><span class="std std-ref">时间和时钟</span></a>). Below is an example
demonstrating two different ways of making time pass quickly. Notice
how in both cases, the two tasks keep a consistent view of reality and
events happen in the expected order, despite being wildly divorced
from real time:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># across-realtime.py</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">trio</span>
<span class="kn">import</span> <span class="nn">trio.testing</span>

<span class="n">YEAR</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># seconds</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">task1</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task1: sleeping for 1 year&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">YEAR</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task1: woke up; clock says I&#39;ve slept </span><span class="si">{</span><span class="n">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">YEAR</span><span class="si">}</span><span class="s2"> years&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task1: sleeping for 1 year, 100 times&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">YEAR</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task1: slept </span><span class="si">{</span><span class="n">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">YEAR</span><span class="si">}</span><span class="s2"> years total&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">task2</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task2: sleeping for 5 years&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">YEAR</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task2: woke up; clock says I&#39;ve slept </span><span class="si">{</span><span class="n">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">YEAR</span><span class="si">}</span><span class="s2"> years&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;task2: sleeping for 500 years&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="n">YEAR</span><span class="p">)</span>

    <span class="n">duration</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">current_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;task2: slept </span><span class="si">{</span><span class="n">duration</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">YEAR</span><span class="si">}</span><span class="s2"> years total&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">trio</span><span class="o">.</span><span class="n">open_nursery</span><span class="p">()</span> <span class="k">as</span> <span class="n">nursery</span><span class="p">:</span>
        <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">task1</span><span class="p">)</span>
        <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">task2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_example</span><span class="p">(</span><span class="n">clock</span><span class="p">):</span>
    <span class="n">real_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">trio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">clock</span><span class="o">=</span><span class="n">clock</span><span class="p">)</span>
    <span class="n">real_duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">real_start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total real time elapsed: </span><span class="si">{</span><span class="n">real_duration</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Clock where time passes at 100 years per second:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">run_example</span><span class="p">(</span><span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">MockClock</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="n">YEAR</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Clock where time automatically skips past the boring parts:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">run_example</span><span class="p">(</span><span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">MockClock</span><span class="p">(</span><span class="n">autojump_threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Clock where time passes at 100 years per second:

task2: sleeping for 5 years
task1: sleeping for 1 year
task1: woke up; clock says I&#39;ve slept 1.0365006048232317 years
task1: sleeping for 1 year, 100 times
task2: woke up; clock says I&#39;ve slept 5.0572111969813704 years
task2: sleeping for 500 years
task1: slept 104.77677842136472 years total
task2: slept 505.25014589075 years total
Total real time elapsed: 5.053582429885864 seconds

Clock where time automatically skips past the boring parts:

task2: sleeping for 5 years
task1: sleeping for 1 year
task1: woke up; clock says I&#39;ve slept 1.0 years
task1: sleeping for 1 year, 100 times
task2: woke up; clock says I&#39;ve slept 5.0 years
task2: sleeping for 500 years
task1: slept 101.0 years total
task2: slept 505.0 years total
Total real time elapsed: 0.019298791885375977 seconds
</pre></div>
</div>
</div>
</div>
<dl class="py class">
<dt class="sig sig-object py" id="trio.testing.MockClock">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">MockClock</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">rate</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">autojump_threshold</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">inf</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MockClock" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference internal" href="ref-core/time_clock.html#trio.abc.Clock" title="trio.abc.Clock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Clock</span></code></a></p>
<p>A user-controllable clock suitable for writing tests.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>rate</strong> (<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#float" title="（在 Python v3.13）"><em>float</em></a>) -- the initial <a class="reference internal" href="#trio.testing.MockClock.rate" title="trio.testing.MockClock.rate"><code class="xref py py-attr docutils literal notranslate"><span class="pre">rate</span></code></a>.</p></li>
<li><p><strong>autojump_threshold</strong> (<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#float" title="（在 Python v3.13）"><em>float</em></a>) -- the initial <a class="reference internal" href="#trio.testing.MockClock.autojump_threshold" title="trio.testing.MockClock.autojump_threshold"><code class="xref py py-attr docutils literal notranslate"><span class="pre">autojump_threshold</span></code></a>.</p></li>
</ul>
</dd>
</dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="trio.testing.MockClock.rate">
<span class="sig-name descname"><span class="pre">rate</span></span><a class="headerlink" href="#trio.testing.MockClock.rate" title="Link to this definition">¶</a></dt>
<dd><p>How many seconds of clock time pass per second of real time. Default is
0.0, i.e. the clock only advances through manuals calls to <a class="reference internal" href="#trio.testing.MockClock.jump" title="trio.testing.MockClock.jump"><code class="xref py py-meth docutils literal notranslate"><span class="pre">jump()</span></code></a>
or when the <a class="reference internal" href="#trio.testing.MockClock.autojump_threshold" title="trio.testing.MockClock.autojump_threshold"><code class="xref py py-attr docutils literal notranslate"><span class="pre">autojump_threshold</span></code></a> is triggered. You can assign to
this attribute to change it.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="trio.testing.MockClock.autojump_threshold">
<span class="sig-name descname"><span class="pre">autojump_threshold</span></span><a class="headerlink" href="#trio.testing.MockClock.autojump_threshold" title="Link to this definition">¶</a></dt>
<dd><p>The clock keeps an eye on the run loop, and if at any point it detects
that all tasks have been blocked for this many real seconds (i.e.,
according to the actual clock, not this clock), then the clock
automatically jumps ahead to the run loop's next scheduled
timeout. Default is <a class="reference external" href="https://docs.python.org/zh-cn/3/library/math.html#math.inf" title="（在 Python v3.13）"><code class="xref py py-data docutils literal notranslate"><span class="pre">math.inf</span></code></a>, i.e., to never autojump. You can
assign to this attribute to change it.</p>
<p>Basically the idea is that if you have code or tests that use sleeps
and timeouts, you can use this to make it run much faster, totally
automatically. (At least, as long as those sleeps/timeouts are
happening inside Trio; if your test involves talking to external
service and waiting for it to timeout then obviously we can't help you
there.)</p>
<p>You should set this to the smallest value that lets you reliably avoid
&quot;false alarms&quot; where some I/O is in flight (e.g. between two halves of
a socketpair) but the threshold gets triggered and time gets advanced
anyway. This will depend on the details of your tests and test
environment. If you aren't doing any I/O (like in our sleeping example
above) then just set it to zero, and the clock will jump whenever all
tasks are blocked.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If you use <code class="docutils literal notranslate"><span class="pre">autojump_threshold</span></code> and
<cite>wait_all_tasks_blocked</cite> at the same time, then you might wonder how
they interact, since they both cause things to happen after the run
loop goes idle for some time. The answer is:
<cite>wait_all_tasks_blocked</cite> takes priority. If there's a task blocked
in <cite>wait_all_tasks_blocked</cite>, then the autojump feature treats that
as active task and does <em>not</em> jump the clock.</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MockClock.jump">
<span class="sig-name descname"><span class="pre">jump</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seconds</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MockClock.jump" title="Link to this definition">¶</a></dt>
<dd><p>Manually advance the clock by the given number of seconds.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>seconds</strong> (<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#float" title="（在 Python v3.13）"><em>float</em></a>) -- the number of seconds to jump the clock forward.</p>
</dd>
<dt class="field-even">抛出<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ValueError" title="（在 Python v3.13）"><strong>ValueError</strong></a> -- if you try to pass a negative value for <code class="docutils literal notranslate"><span class="pre">seconds</span></code>.</p>
</dd>
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
<section id="id3">
<h2>任务排序<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Inter-task ordering</strong></p>
<dl class="py class">
<dt class="sig sig-object py" id="trio.testing.Sequencer">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">Sequencer</span></span><a class="headerlink" href="#trio.testing.Sequencer" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#object" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a></p>
<p>A convenience class for forcing code in different tasks to run in an
explicit linear order.</p>
<p>Instances of this class implement a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method which returns an
async context manager. The idea is that you pass a sequence number to
<code class="docutils literal notranslate"><span class="pre">__call__</span></code> to say where this block of code should go in the linear
sequence. Block 0 starts immediately, and then block N doesn't start until
block N-1 has finished.</p>
<p class="rubric">示例</p>
<p>An extremely elaborate way to print the numbers 0-5, in order:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">worker1</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">seq</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">seq</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">worker2</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">seq</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">seq</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">worker3</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">seq</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
   <span class="n">seq</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">Sequencer</span><span class="p">()</span>
   <span class="k">async</span> <span class="k">with</span> <span class="n">trio</span><span class="o">.</span><span class="n">open_nursery</span><span class="p">()</span> <span class="k">as</span> <span class="n">nursery</span><span class="p">:</span>
       <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">worker1</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
       <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">worker2</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
       <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">worker3</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.wait_all_tasks_blocked">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">wait_all_tasks_blocked</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">cushion</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.wait_all_tasks_blocked" title="Link to this definition">¶</a></dt>
<dd><p>Block until there are no runnable tasks.</p>
<p>This is useful in testing code when you want to give other tasks a
chance to &quot;settle down&quot;. The calling task is blocked, and doesn't wake
up until all other tasks are also blocked for at least <code class="docutils literal notranslate"><span class="pre">cushion</span></code>
seconds. (Setting a non-zero <code class="docutils literal notranslate"><span class="pre">cushion</span></code> is intended to handle cases
like two tasks talking to each other over a local socket, where we
want to ignore the potential brief moment between a send and receive
when all tasks are blocked.)</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">cushion</span></code> is measured in <em>real</em> time, not the Trio clock
time.</p>
<p>If there are multiple tasks blocked in <a class="reference internal" href="#trio.testing.wait_all_tasks_blocked" title="trio.testing.wait_all_tasks_blocked"><code class="xref py py-func docutils literal notranslate"><span class="pre">wait_all_tasks_blocked()</span></code></a>,
then the one with the shortest <code class="docutils literal notranslate"><span class="pre">cushion</span></code> is the one woken (and
this task becoming unblocked resets the timers for the remaining
tasks). If there are multiple tasks that have exactly the same
<code class="docutils literal notranslate"><span class="pre">cushion</span></code>, then all are woken.</p>
<p>You should also consider <a class="reference internal" href="#trio.testing.Sequencer" title="trio.testing.Sequencer"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.testing.Sequencer</span></code></a>, which
provides a more explicit way to control execution ordering within a
test, and will often produce more readable tests.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
<p class="rubric">示例</p>
<p>Here's an example of one way to test that Trio's locks are fair: we
take the lock in the parent, start a child, wait for the child to be
blocked waiting for the lock (!), and then check that we can't
release and immediately re-acquire the lock:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">lock_taker</span><span class="p">(</span><span class="n">lock</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">test_lock_fairness</span><span class="p">():</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">trio</span><span class="o">.</span><span class="n">open_nursery</span><span class="p">()</span> <span class="k">as</span> <span class="n">nursery</span><span class="p">:</span>
        <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">lock_taker</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>
        <span class="c1"># child hasn&#39;t run yet, we have the lock</span>
        <span class="k">assert</span> <span class="n">lock</span><span class="o">.</span><span class="n">locked</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">lock</span><span class="o">.</span><span class="n">_owner</span> <span class="ow">is</span> <span class="n">trio</span><span class="o">.</span><span class="n">lowlevel</span><span class="o">.</span><span class="n">current_task</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">wait_all_tasks_blocked</span><span class="p">()</span>
        <span class="c1"># now the child has run and is blocked on lock.acquire(), we</span>
        <span class="c1"># still have the lock</span>
        <span class="k">assert</span> <span class="n">lock</span><span class="o">.</span><span class="n">locked</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">lock</span><span class="o">.</span><span class="n">_owner</span> <span class="ow">is</span> <span class="n">trio</span><span class="o">.</span><span class="n">lowlevel</span><span class="o">.</span><span class="n">current_task</span><span class="p">()</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The child has a prior claim, so we can&#39;t have it</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire_nowait</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">trio</span><span class="o">.</span><span class="n">WouldBlock</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">lock</span><span class="o">.</span><span class="n">_owner</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">trio</span><span class="o">.</span><span class="n">lowlevel</span><span class="o">.</span><span class="n">current_task</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PASS&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FAIL&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.wait_all_threads_completed">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">wait_all_threads_completed</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.wait_all_threads_completed" title="Link to this definition">¶</a></dt>
<dd><p>Wait until no threads are still running tasks.</p>
<p>This is intended to be used when testing code with trio.to_thread to
make sure no tasks are still making progress in a thread. See the
following code for a usage example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">wait_all_settled</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">wait_all_threads_complete</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">wait_all_tasks_blocked</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">active_thread_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.active_thread_count">
<span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">active_thread_count</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.active_thread_count" title="Link to this definition">¶</a></dt>
<dd><p>Returns the number of threads that are currently running a task</p>
<p>See <cite>trio.testing.wait_all_threads_completed</cite></p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

</section>
<section id="testing-streams">
<span id="id4"></span><h2>流<a class="headerlink" href="#testing-streams" title="Link to this heading">¶</a></h2>
<p><strong>Streams</strong></p>
<section id="id5">
<h3>连接到进程内套接字服务器<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p><strong>Connecting to an in-process socket server</strong></p>
<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.open_stream_to_socket_listener">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">open_stream_to_socket_listener</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">socket_listener</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.open_stream_to_socket_listener" title="Link to this definition">¶</a></dt>
<dd><p>Connect to the given <a class="reference internal" href="ref-io/abs_api.html#trio.SocketListener" title="trio.SocketListener"><code class="xref py py-class docutils literal notranslate"><span class="pre">SocketListener</span></code></a>.</p>
<p>This is particularly useful in tests when you want to let a server pick
its own port, and then connect to it:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">listeners</span> <span class="o">=</span> <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">open_tcp_listeners</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">open_stream_to_socket_listener</span><span class="p">(</span><span class="n">listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>socket_listener</strong> (<a class="reference internal" href="ref-io/abs_api.html#trio.SocketListener" title="trio.SocketListener"><em>SocketListener</em></a>) -- The
<a class="reference internal" href="ref-io/abs_api.html#trio.SocketListener" title="trio.SocketListener"><code class="xref py py-class docutils literal notranslate"><span class="pre">SocketListener</span></code></a> to connect to.</p>
</dd>
<dt class="field-even">返回<span class="colon">:</span></dt>
<dd class="field-even"><p>a stream connected to the given listener.</p>
</dd>
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="ref-io/abs_api.html#trio.SocketStream" title="trio.SocketStream">SocketStream</a></p>
</dd>
</dl>
</dd></dl>

</section>
<section id="virtual-streams">
<span id="id6"></span><h3>虚拟、可控流<a class="headerlink" href="#virtual-streams" title="Link to this heading">¶</a></h3>
<p><strong>Virtual, controllable streams</strong></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p>测试网络协议时，一个特别具有挑战性的问题是确保你的实现能够处理数据流被奇怪地切断并以奇怪的时序到达的情况：本地主机连接往往比真实网络表现得要好得多，因此如果你只在本地主机上进行测试，可能在后期会遇到问题。为了帮助你，Trio 提供了一些完全基于内存的流接口实现（参见 <a class="reference internal" href="ref-io/abs_api.html#abstract-stream-api"><span class="std std-ref">抽象流 API</span></a>），让你可以编写各种有趣的恶意测试。</p>
<p>这里有几个部分，它们是如何组合在一起的：</p>
<p><a class="reference internal" href="#trio.testing.memory_stream_pair" title="trio.testing.memory_stream_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pair()</span></code></a> 提供了一对连接的双向流。它类似于 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/socket.html#socket.socketpair" title="（在 Python v3.13）"><code class="xref py py-func docutils literal notranslate"><span class="pre">socket.socketpair()</span></code></a>，但是不涉及那讨厌的操作系统及其网络栈。</p>
<p>要构建一个双向流，<a class="reference internal" href="#trio.testing.memory_stream_pair" title="trio.testing.memory_stream_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pair()</span></code></a> 使用了两个单向流。它通过调用 <a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a> 来获得这两个流。</p>
<p><a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a> 又是使用较低级别的类 <a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a> 和 <a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a> 实现的。这些类是 (你猜对了) <a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.abc.SendStream</span></code></a> 和 <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.abc.ReceiveStream</span></code></a> 的实现，它们本身不连接任何东西——“发送”和“接收”只是将数据放入和从各自拥有的私有内部缓冲区中取出数据。它们还提供了一些有趣的钩子，允许你自定义其方法的行为。如果你愿意，这里可以插入一些恶意代码。<a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a> 以相对简单的方式利用了这些钩子：它只是设置，当你调用 <code class="docutils literal notranslate"><span class="pre">send_all</span></code> 或关闭发送流时，它会自动触发对 <a class="reference internal" href="#trio.testing.memory_stream_pump" title="trio.testing.memory_stream_pump"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pump()</span></code></a> 的调用，后者是一个便捷函数，从 <a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a> 的缓冲区中取出数据，并将其放入 <a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a> 的缓冲区。但这只是默认行为——你可以用任何你想要的自定义行为替换它。</p>
<p>Trio 还提供了一些专门用于测试完全 <strong>未</strong> 缓冲流的函数：<a class="reference internal" href="#trio.testing.lockstep_stream_one_way_pair" title="trio.testing.lockstep_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">lockstep_stream_one_way_pair()</span></code></a> 和 <a class="reference internal" href="#trio.testing.lockstep_stream_pair" title="trio.testing.lockstep_stream_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">lockstep_stream_pair()</span></code></a>。这些函数不可定制，但它们展现了一种极端的行为，对于捕捉协议实现中的边界情况非常有效。</p>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>One particularly challenging problem when testing network protocols is
making sure that your implementation can handle data whose flow gets
broken up in weird ways and arrives with weird timings: localhost
connections tend to be much better behaved than real networks, so if
you only test on localhost then you might get bitten later. To help
you out, Trio provides some fully in-memory implementations of the
stream interfaces (see <a class="reference internal" href="ref-io/abs_api.html#abstract-stream-api"><span class="std std-ref">抽象流 API</span></a>), that let you write
all kinds of interestingly evil tests.</p>
<p>There are a few pieces here, so here's how they fit together:</p>
<p><a class="reference internal" href="#trio.testing.memory_stream_pair" title="trio.testing.memory_stream_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pair()</span></code></a> gives you a pair of connected,
bidirectional streams. It's like <a class="reference external" href="https://docs.python.org/zh-cn/3/library/socket.html#socket.socketpair" title="（在 Python v3.13）"><code class="xref py py-func docutils literal notranslate"><span class="pre">socket.socketpair()</span></code></a>, but
without any involvement from that pesky operating system and its
networking stack.</p>
<p>To build a bidirectional stream, <a class="reference internal" href="#trio.testing.memory_stream_pair" title="trio.testing.memory_stream_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pair()</span></code></a> uses
two unidirectional streams. It gets these by calling
<a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a>.</p>
<p><a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a>, in turn, is implemented using the
low-ish level classes <a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a> and
<a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a>. These are implementations of (you
guessed it) <a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.abc.SendStream</span></code></a> and
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.abc.ReceiveStream</span></code></a> that on their own, aren't attached to
anything – &quot;sending&quot; and &quot;receiving&quot; just put data into and get data
out of a private internal buffer that each object owns. They also have
some interesting hooks you can set, that let you customize the
behavior of their methods. This is where you can insert the evil, if
you want it. <a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a> takes advantage of
these hooks in a relatively boring way: it just sets it up so that
when you call <code class="docutils literal notranslate"><span class="pre">send_all</span></code>, or when you close the send stream, then it
automatically triggers a call to <a class="reference internal" href="#trio.testing.memory_stream_pump" title="trio.testing.memory_stream_pump"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pump()</span></code></a>, which is
a convenience function that takes data out of a
<a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a>´s buffer and puts it into a
<a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a>´s buffer. But that's just the default –
you can replace this with whatever arbitrary behavior you want.</p>
<p>Trio also provides some specialized functions for testing completely
<strong>un</strong>buffered streams: <a class="reference internal" href="#trio.testing.lockstep_stream_one_way_pair" title="trio.testing.lockstep_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">lockstep_stream_one_way_pair()</span></code></a> and
<a class="reference internal" href="#trio.testing.lockstep_stream_pair" title="trio.testing.lockstep_stream_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">lockstep_stream_pair()</span></code></a>. These aren't customizable, but they do
exhibit an extreme kind of behavior that's good at catching out edge
cases in protocol implementations.</p>
</div>
</div>
</section>
<section id="api">
<h3>API 详细信息<a class="headerlink" href="#api" title="Link to this heading">¶</a></h3>
<p><strong>API details</strong></p>
<dl class="py class">
<dt class="sig sig-object py" id="trio.testing.MemorySendStream">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">MemorySendStream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">send_all_hook</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wait_send_all_might_not_block_hook</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">close_hook</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemorySendStream" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a></p>
<p>An in-memory <a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>send_all_hook</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Awaitable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Awaitable</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#object" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a>]] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span>) -- An async function, or None. Called from
<a class="reference internal" href="#trio.testing.MemorySendStream.send_all" title="trio.testing.MemorySendStream.send_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send_all()</span></code></a>. Can do whatever you like.</p></li>
<li><p><strong>wait_send_all_might_not_block_hook</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Awaitable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Awaitable</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#object" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a>]] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span>) -- An async function, or None. Called
from <a class="reference internal" href="#trio.testing.MemorySendStream.wait_send_all_might_not_block" title="trio.testing.MemorySendStream.wait_send_all_might_not_block"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_send_all_might_not_block()</span></code></a>. Can do whatever you
like.</p></li>
<li><p><strong>close_hook</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#object" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a>] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span>) -- A synchronous function, or None. Called from <a class="reference internal" href="#trio.testing.MemorySendStream.close" title="trio.testing.MemorySendStream.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a>
and <a class="reference internal" href="#trio.testing.MemorySendStream.aclose" title="trio.testing.MemorySendStream.aclose"><code class="xref py py-meth docutils literal notranslate"><span class="pre">aclose()</span></code></a>. Can do whatever you like.</p></li>
</ul>
</dd>
</dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.send_all_hook">
<span class="sig-name descname"><span class="pre">send_all_hook</span></span><a class="headerlink" href="#trio.testing.MemorySendStream.send_all_hook" title="Link to this definition">¶</a></dt>
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.wait_send_all_might_not_block_hook">
<span class="sig-name descname"><span class="pre">wait_send_all_might_not_block_hook</span></span><a class="headerlink" href="#trio.testing.MemorySendStream.wait_send_all_might_not_block_hook" title="Link to this definition">¶</a></dt>
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.close_hook">
<span class="sig-name descname"><span class="pre">close_hook</span></span><a class="headerlink" href="#trio.testing.MemorySendStream.close_hook" title="Link to this definition">¶</a></dt>
<dd><p>All of these hooks are also exposed as attributes on the object, and
you can change them at any time.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.aclose">
<em class="property"><span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">aclose</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemorySendStream.aclose" title="Link to this definition">¶</a></dt>
<dd><p>Same as <a class="reference internal" href="#trio.testing.MemorySendStream.close" title="trio.testing.MemorySendStream.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a>, but async.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.close">
<span class="sig-name descname"><span class="pre">close</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemorySendStream.close" title="Link to this definition">¶</a></dt>
<dd><p>Marks this stream as closed, and then calls the <a class="reference internal" href="#trio.testing.MemorySendStream.close_hook" title="trio.testing.MemorySendStream.close_hook"><code class="xref py py-attr docutils literal notranslate"><span class="pre">close_hook</span></code></a>
(if any).</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.get_data">
<em class="property"><span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">get_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">max_bytes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemorySendStream.get_data" title="Link to this definition">¶</a></dt>
<dd><p>Retrieves data from the internal buffer, blocking if necessary.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>max_bytes</strong> (<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><em>int</em></a><em> or </em><em>None</em>) -- The maximum amount of data to
retrieve. None (the default) means to retrieve all the data
that's present (but still blocks until at least one byte is
available).</p>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#bytearray" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytearray</span></code></a></span></p>
</dd>
<dt class="field-odd">返回<span class="colon">:</span></dt>
<dd class="field-odd"><p>If this stream has been closed, an empty bytearray. Otherwise, the
requested data.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.get_data_nowait">
<span class="sig-name descname"><span class="pre">get_data_nowait</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">max_bytes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemorySendStream.get_data_nowait" title="Link to this definition">¶</a></dt>
<dd><p>Retrieves data from the internal buffer, but doesn't block.</p>
<p>See <a class="reference internal" href="#trio.testing.MemorySendStream.get_data" title="trio.testing.MemorySendStream.get_data"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_data()</span></code></a> for details.</p>
<dl class="field-list simple">
<dt class="field-odd">抛出<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="ref-core/exc_warn.html#trio.WouldBlock" title="trio.WouldBlock"><strong>trio.WouldBlock</strong></a> -- if no data is available to retrieve.</p>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#bytearray" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytearray</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.send_all">
<em class="property"><span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">send_all</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemorySendStream.send_all" title="Link to this definition">¶</a></dt>
<dd><p>Places the given data into the object's internal buffer, and then
calls the <a class="reference internal" href="#trio.testing.MemorySendStream.send_all_hook" title="trio.testing.MemorySendStream.send_all_hook"><code class="xref py py-attr docutils literal notranslate"><span class="pre">send_all_hook</span></code></a> (if any).</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemorySendStream.wait_send_all_might_not_block">
<em class="property"><span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">wait_send_all_might_not_block</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemorySendStream.wait_send_all_might_not_block" title="Link to this definition">¶</a></dt>
<dd><p>Calls the <a class="reference internal" href="#trio.testing.MemorySendStream.wait_send_all_might_not_block_hook" title="trio.testing.MemorySendStream.wait_send_all_might_not_block_hook"><code class="xref py py-attr docutils literal notranslate"><span class="pre">wait_send_all_might_not_block_hook</span></code></a> (if any), and
then returns immediately.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="trio.testing.MemoryReceiveStream">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">MemoryReceiveStream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">receive_some_hook</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">close_hook</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemoryReceiveStream" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a></p>
<p>An in-memory <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>receive_some_hook</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Awaitable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Awaitable</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#object" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a>]] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span>) -- An async function, or None. Called from
<a class="reference internal" href="#trio.testing.MemoryReceiveStream.receive_some" title="trio.testing.MemoryReceiveStream.receive_some"><code class="xref py py-meth docutils literal notranslate"><span class="pre">receive_some()</span></code></a>. Can do whatever you like.</p></li>
<li><p><strong>close_hook</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#object" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></a>] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span>) -- A synchronous function, or None. Called from <a class="reference internal" href="#trio.testing.MemoryReceiveStream.close" title="trio.testing.MemoryReceiveStream.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a>
and <a class="reference internal" href="#trio.testing.MemoryReceiveStream.aclose" title="trio.testing.MemoryReceiveStream.aclose"><code class="xref py py-meth docutils literal notranslate"><span class="pre">aclose()</span></code></a>. Can do whatever you like.</p></li>
</ul>
</dd>
</dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="trio.testing.MemoryReceiveStream.receive_some_hook">
<span class="sig-name descname"><span class="pre">receive_some_hook</span></span><a class="headerlink" href="#trio.testing.MemoryReceiveStream.receive_some_hook" title="Link to this definition">¶</a></dt>
<dt class="sig sig-object py" id="trio.testing.MemoryReceiveStream.close_hook">
<span class="sig-name descname"><span class="pre">close_hook</span></span><a class="headerlink" href="#trio.testing.MemoryReceiveStream.close_hook" title="Link to this definition">¶</a></dt>
<dd><p>Both hooks are also exposed as attributes on the object, and you can
change them at any time.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemoryReceiveStream.aclose">
<em class="property"><span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">aclose</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemoryReceiveStream.aclose" title="Link to this definition">¶</a></dt>
<dd><p>Same as <a class="reference internal" href="#trio.testing.MemoryReceiveStream.close" title="trio.testing.MemoryReceiveStream.close"><code class="xref py py-meth docutils literal notranslate"><span class="pre">close()</span></code></a>, but async.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemoryReceiveStream.close">
<span class="sig-name descname"><span class="pre">close</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemoryReceiveStream.close" title="Link to this definition">¶</a></dt>
<dd><p>Discards any pending data from the internal buffer, and marks this
stream as closed.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemoryReceiveStream.put_data">
<span class="sig-name descname"><span class="pre">put_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">data</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemoryReceiveStream.put_data" title="Link to this definition">¶</a></dt>
<dd><p>Appends the given data to the internal buffer.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemoryReceiveStream.put_eof">
<span class="sig-name descname"><span class="pre">put_eof</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemoryReceiveStream.put_eof" title="Link to this definition">¶</a></dt>
<dd><p>Adds an end-of-file marker to the internal buffer.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.MemoryReceiveStream.receive_some">
<em class="property"><span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">receive_some</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">max_bytes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.MemoryReceiveStream.receive_some" title="Link to this definition">¶</a></dt>
<dd><p>Calls the <a class="reference internal" href="#trio.testing.MemoryReceiveStream.receive_some_hook" title="trio.testing.MemoryReceiveStream.receive_some_hook"><code class="xref py py-attr docutils literal notranslate"><span class="pre">receive_some_hook</span></code></a> (if any), and then retrieves
data from the internal buffer, blocking if necessary.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#bytearray" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">bytearray</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.memory_stream_pump">
<span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">memory_stream_pump</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">memory_send_stream</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">memory_receive_stream</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_bytes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.memory_stream_pump" title="Link to this definition">¶</a></dt>
<dd><p>Take data out of the given <a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a>'s internal buffer,
and put it into the given <a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a>'s internal buffer.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>memory_send_stream</strong> (<a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><em>MemorySendStream</em></a>) -- The stream to get data from.</p></li>
<li><p><strong>memory_receive_stream</strong> (<a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><em>MemoryReceiveStream</em></a>) -- The stream to put data into.</p></li>
<li><p><strong>max_bytes</strong> (<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><em>int</em></a><em> or </em><em>None</em>) -- The maximum amount of data to transfer in this
call, or None to transfer all available data.</p></li>
</ul>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#bool" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">bool</span></code></a></span></p>
</dd>
<dt class="field-odd">返回<span class="colon">:</span></dt>
<dd class="field-odd"><p>True if it successfully transferred some data, or False if there was no
data to transfer.</p>
</dd>
</dl>
<p>This is used to implement <a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a> and
<a class="reference internal" href="#trio.testing.memory_stream_pair" title="trio.testing.memory_stream_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pair()</span></code></a>; see the latter's docstring for an example
of how you might use it yourself.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.memory_stream_one_way_pair">
<span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">memory_stream_one_way_pair</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.memory_stream_one_way_pair" title="Link to this definition">¶</a></dt>
<dd><p>Create a connected, pure-Python, unidirectional stream with infinite
buffering and flexible configuration options.</p>
<p>You can think of this as being a no-operating-system-involved
Trio-streamsified version of <a class="reference external" href="https://docs.python.org/zh-cn/3/library/os.html#os.pipe" title="（在 Python v3.13）"><code class="xref py py-func docutils literal notranslate"><span class="pre">os.pipe()</span></code></a> (except that <a class="reference external" href="https://docs.python.org/zh-cn/3/library/os.html#os.pipe" title="（在 Python v3.13）"><code class="xref py py-func docutils literal notranslate"><span class="pre">os.pipe()</span></code></a>
returns the streams in the wrong order – we follow the superior convention
that data flows from left to right).</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a>, <a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a>]</span></p>
</dd>
<dt class="field-even">返回<span class="colon">:</span></dt>
<dd class="field-even"><p>A tuple (<a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a>, <a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a>), where
the <a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a> has its hooks set up so that it calls
<a class="reference internal" href="#trio.testing.memory_stream_pump" title="trio.testing.memory_stream_pump"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pump()</span></code></a> from its
<a class="reference internal" href="#trio.testing.MemorySendStream.send_all_hook" title="trio.testing.MemorySendStream.send_all_hook"><code class="xref py py-attr docutils literal notranslate"><span class="pre">send_all_hook</span></code></a> and
<a class="reference internal" href="#trio.testing.MemorySendStream.close_hook" title="trio.testing.MemorySendStream.close_hook"><code class="xref py py-attr docutils literal notranslate"><span class="pre">close_hook</span></code></a>.</p>
</dd>
</dl>
<p>The end result is that data automatically flows from the
<a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a> to the <a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a>. But you're
also free to rearrange things however you like. For example, you can
temporarily set the <a class="reference internal" href="#trio.testing.MemorySendStream.send_all_hook" title="trio.testing.MemorySendStream.send_all_hook"><code class="xref py py-attr docutils literal notranslate"><span class="pre">send_all_hook</span></code></a> to None if you
want to simulate a stall in data transmission. Or see
<a class="reference internal" href="#trio.testing.memory_stream_pair" title="trio.testing.memory_stream_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_pair()</span></code></a> for a more elaborate example.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.memory_stream_pair">
<span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">memory_stream_pair</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.memory_stream_pair" title="Link to this definition">¶</a></dt>
<dd><p>Create a connected, pure-Python, bidirectional stream with infinite
buffering and flexible configuration options.</p>
<p>This is a convenience function that creates two one-way streams using
<a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a>, and then uses
<a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a> to combine them into a single bidirectional
stream.</p>
<p>This is like a no-operating-system-involved, Trio-streamsified version of
<a class="reference external" href="https://docs.python.org/zh-cn/3/library/socket.html#socket.socketpair" title="（在 Python v3.13）"><code class="xref py py-func docutils literal notranslate"><span class="pre">socket.socketpair()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a>[<a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a>, <a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a>], <a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a>[<a class="reference internal" href="#trio.testing.MemorySendStream" title="trio.testing.MemorySendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a>, <a class="reference internal" href="#trio.testing.MemoryReceiveStream" title="trio.testing.MemoryReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a>]]</span></p>
</dd>
<dt class="field-even">返回<span class="colon">:</span></dt>
<dd class="field-even"><p>A pair of <a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a> objects that are connected so
that data automatically flows from one to the other in both directions.</p>
</dd>
</dl>
<p>After creating a stream pair, you can send data back and forth, which is
enough for simple tests:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">memory_stream_pair</span><span class="p">()</span>
<span class="k">await</span> <span class="n">left</span><span class="o">.</span><span class="n">send_all</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;123&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="k">await</span> <span class="n">right</span><span class="o">.</span><span class="n">receive_some</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;123&quot;</span>
<span class="k">await</span> <span class="n">right</span><span class="o">.</span><span class="n">send_all</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;456&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="k">await</span> <span class="n">left</span><span class="o">.</span><span class="n">receive_some</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;456&quot;</span>
</pre></div>
</div>
<p>But if you read the docs for <a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a> and
<a class="reference internal" href="#trio.testing.memory_stream_one_way_pair" title="trio.testing.memory_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a>, you'll see that all the pieces
involved in wiring this up are public APIs, so you can adjust to suit the
requirements of your tests. For example, here's how to tweak a stream so
that data flowing from left to right trickles in one byte at a time (but
data flowing from right to left proceeds at full speed):</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">memory_stream_pair</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">trickle</span><span class="p">():</span>
    <span class="c1"># left is a StapledStream, and left.send_stream is a MemorySendStream</span>
    <span class="c1"># right is a StapledStream, and right.recv_stream is a MemoryReceiveStream</span>
    <span class="k">while</span> <span class="n">memory_stream_pump</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">send_stream</span><span class="p">,</span> <span class="n">right</span><span class="o">.</span><span class="n">recv_stream</span><span class="p">,</span> <span class="n">max_bytes</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Pause between each byte</span>
        <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Normally this send_all_hook calls memory_stream_pump directly without</span>
<span class="c1"># passing in a max_bytes. We replace it with our custom version:</span>
<span class="n">left</span><span class="o">.</span><span class="n">send_stream</span><span class="o">.</span><span class="n">send_all_hook</span> <span class="o">=</span> <span class="n">trickle</span>
</pre></div>
</div>
<p>And here's a simple test using our modified stream objects:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">sender</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">left</span><span class="o">.</span><span class="n">send_all</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;12345&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">left</span><span class="o">.</span><span class="n">send_eof</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">receiver</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">right</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">async</span> <span class="k">with</span> <span class="n">trio</span><span class="o">.</span><span class="n">open_nursery</span><span class="p">()</span> <span class="k">as</span> <span class="n">nursery</span><span class="p">:</span>
    <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
    <span class="n">nursery</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">receiver</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, this will print <code class="docutils literal notranslate"><span class="pre">b&quot;12345&quot;</span></code> and then immediately exit; with
our trickle stream it instead sleeps 1 second, then prints <code class="docutils literal notranslate"><span class="pre">b&quot;1&quot;</span></code>, then
sleeps 1 second, then prints <code class="docutils literal notranslate"><span class="pre">b&quot;2&quot;</span></code>, etc.</p>
<p>Pro-tip: you can insert sleep calls (like in our example above) to
manipulate the flow of data across tasks... and then use
<a class="reference internal" href="#trio.testing.MockClock" title="trio.testing.MockClock"><code class="xref py py-class docutils literal notranslate"><span class="pre">MockClock</span></code></a> and its <a class="reference internal" href="#trio.testing.MockClock.autojump_threshold" title="trio.testing.MockClock.autojump_threshold"><code class="xref py py-attr docutils literal notranslate"><span class="pre">autojump_threshold</span></code></a>
functionality to keep your test suite running quickly.</p>
<p>If you want to stress test a protocol implementation, one nice trick is to
use the <a class="reference external" href="https://docs.python.org/zh-cn/3/library/random.html#module-random" title="（在 Python v3.13）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">random</span></code></a> module (preferably with a fixed seed) to move random
numbers of bytes at a time, and insert random sleeps in between them. You
can also set up a custom <a class="reference internal" href="#trio.testing.MemoryReceiveStream.receive_some_hook" title="trio.testing.MemoryReceiveStream.receive_some_hook"><code class="xref py py-attr docutils literal notranslate"><span class="pre">receive_some_hook</span></code></a> if
you want to manipulate things on the receiving side, and not just the
sending side.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.lockstep_stream_one_way_pair">
<span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">lockstep_stream_one_way_pair</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.lockstep_stream_one_way_pair" title="Link to this definition">¶</a></dt>
<dd><p>Create a connected, pure Python, unidirectional stream where data flows
in lockstep.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>]</span></p>
</dd>
<dt class="field-even">返回<span class="colon">:</span></dt>
<dd class="field-even"><p>A tuple
(<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>).</p>
</dd>
</dl>
<p>This stream has <em>absolutely no</em> buffering. Each call to
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream.send_all" title="trio.abc.SendStream.send_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send_all()</span></code></a> will block until all the given data
has been returned by a call to
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream.receive_some" title="trio.abc.ReceiveStream.receive_some"><code class="xref py py-meth docutils literal notranslate"><span class="pre">receive_some()</span></code></a>.</p>
<p>This can be useful for testing flow control mechanisms in an extreme case,
or for setting up &quot;clogged&quot; streams to use with
<a class="reference internal" href="#trio.testing.check_one_way_stream" title="trio.testing.check_one_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_one_way_stream()</span></code></a> and friends.</p>
<p>In addition to fulfilling the <a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a> and
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a> interfaces, the return objects
also have a synchronous <code class="docutils literal notranslate"><span class="pre">close</span></code> method.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.lockstep_stream_pair">
<span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">lockstep_stream_pair</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.lockstep_stream_pair" title="Link to this definition">¶</a></dt>
<dd><p>Create a connected, pure-Python, bidirectional stream where data flows
in lockstep.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>], <a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>]]</span></p>
</dd>
<dt class="field-even">返回<span class="colon">:</span></dt>
<dd class="field-even"><p>A tuple (<a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a>).</p>
</dd>
</dl>
<p>This is a convenience function that creates two one-way streams using
<a class="reference internal" href="#trio.testing.lockstep_stream_one_way_pair" title="trio.testing.lockstep_stream_one_way_pair"><code class="xref py py-func docutils literal notranslate"><span class="pre">lockstep_stream_one_way_pair()</span></code></a>, and then uses
<a class="reference internal" href="ref-io/abs_api.html#trio.StapledStream" title="trio.StapledStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledStream</span></code></a> to combine them into a single bidirectional
stream.</p>
</dd></dl>

</section>
<section id="testing-custom-streams">
<span id="id7"></span><h3>测试自定义流实现<a class="headerlink" href="#testing-custom-streams" title="Link to this heading">¶</a></h3>
<p><strong>Testing custom stream implementations</strong></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p>Trio 还提供了一些功能来帮助您测试自定义流实现：</p>
<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.check_one_way_stream">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">check_one_way_stream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stream_maker</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">clogged_stream_maker</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.check_one_way_stream" title="Link to this definition">¶</a></dt>
<dd><p>Perform a number of generic tests on a custom one-way stream
implementation.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>stream_maker</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Awaitable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Awaitable</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>]]]</span>) -- An async (!) function which returns a connected
(<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>)
pair.</p></li>
<li><p><strong>clogged_stream_maker</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Awaitable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Awaitable</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>]]] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span>) -- Either None, or an async function similar to
stream_maker, but with the extra property that the returned stream
is in a state where <code class="docutils literal notranslate"><span class="pre">send_all</span></code> and
<code class="docutils literal notranslate"><span class="pre">wait_send_all_might_not_block</span></code> will block until <code class="docutils literal notranslate"><span class="pre">receive_some</span></code>
has been called. This allows for more thorough testing of some edge
cases, especially around <code class="docutils literal notranslate"><span class="pre">wait_send_all_might_not_block</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">抛出<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#AssertionError" title="（在 Python v3.13）"><strong>AssertionError</strong></a> -- if a test fails.</p>
</dd>
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.check_two_way_stream">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">check_two_way_stream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stream_maker</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">clogged_stream_maker</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.check_two_way_stream" title="Link to this definition">¶</a></dt>
<dd><p>Perform a number of generic tests on a custom two-way stream
implementation.</p>
<p>This is similar to <a class="reference internal" href="#trio.testing.check_one_way_stream" title="trio.testing.check_one_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_one_way_stream()</span></code></a>, except that the maker
functions are expected to return objects implementing the
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.Stream" title="trio.abc.Stream"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stream</span></code></a> interface.</p>
<p>This function tests a <em>superset</em> of what <a class="reference internal" href="#trio.testing.check_one_way_stream" title="trio.testing.check_one_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_one_way_stream()</span></code></a>
checks – if you call this, then you don't need to also call
<a class="reference internal" href="#trio.testing.check_one_way_stream" title="trio.testing.check_one_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_one_way_stream()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.check_half_closeable_stream">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">check_half_closeable_stream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stream_maker</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">clogged_stream_maker</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.check_half_closeable_stream" title="Link to this definition">¶</a></dt>
<dd><p>Perform a number of generic tests on a custom half-closeable stream
implementation.</p>
<p>This is similar to <a class="reference internal" href="#trio.testing.check_two_way_stream" title="trio.testing.check_two_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_two_way_stream()</span></code></a>, except that the maker
functions are expected to return objects that implement the
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.HalfCloseableStream" title="trio.abc.HalfCloseableStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">HalfCloseableStream</span></code></a> interface.</p>
<p>This function tests a <em>superset</em> of what <a class="reference internal" href="#trio.testing.check_two_way_stream" title="trio.testing.check_two_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_two_way_stream()</span></code></a>
checks – if you call this, then you don't need to also call
<a class="reference internal" href="#trio.testing.check_two_way_stream" title="trio.testing.check_two_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_two_way_stream()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>Trio also provides some functions to help you test your custom stream implementations:</p>
<dl class="py function">
<dt class="sig sig-object py">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">check_one_way_stream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stream_maker</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">clogged_stream_maker</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Perform a number of generic tests on a custom one-way stream
implementation.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>stream_maker</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Awaitable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Awaitable</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>]]]</span>) -- An async (!) function which returns a connected
(<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>)
pair.</p></li>
<li><p><strong>clogged_stream_maker</strong> (<span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Callable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callable</span></code></a>[[], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/collections.abc.html#collections.abc.Awaitable" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Awaitable</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference internal" href="ref-io/abs_api.html#trio.abc.SendStream" title="trio.abc.SendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">SendStream</span></code></a>, <a class="reference internal" href="ref-io/abs_api.html#trio.abc.ReceiveStream" title="trio.abc.ReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ReceiveStream</span></code></a>]]] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span>) -- Either None, or an async function similar to
stream_maker, but with the extra property that the returned stream
is in a state where <code class="docutils literal notranslate"><span class="pre">send_all</span></code> and
<code class="docutils literal notranslate"><span class="pre">wait_send_all_might_not_block</span></code> will block until <code class="docutils literal notranslate"><span class="pre">receive_some</span></code>
has been called. This allows for more thorough testing of some edge
cases, especially around <code class="docutils literal notranslate"><span class="pre">wait_send_all_might_not_block</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">抛出<span class="colon">:</span></dt>
<dd class="field-even"><p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#AssertionError" title="（在 Python v3.13）"><strong>AssertionError</strong></a> -- if a test fails.</p>
</dd>
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">check_two_way_stream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stream_maker</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">clogged_stream_maker</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Perform a number of generic tests on a custom two-way stream
implementation.</p>
<p>This is similar to <a class="reference internal" href="#trio.testing.check_one_way_stream" title="trio.testing.check_one_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_one_way_stream()</span></code></a>, except that the maker
functions are expected to return objects implementing the
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.Stream" title="trio.abc.Stream"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stream</span></code></a> interface.</p>
<p>This function tests a <em>superset</em> of what <a class="reference internal" href="#trio.testing.check_one_way_stream" title="trio.testing.check_one_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_one_way_stream()</span></code></a>
checks – if you call this, then you don't need to also call
<a class="reference internal" href="#trio.testing.check_one_way_stream" title="trio.testing.check_one_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_one_way_stream()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<em class="property"><span class="pre">await</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">check_half_closeable_stream</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">stream_maker</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">clogged_stream_maker</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Perform a number of generic tests on a custom half-closeable stream
implementation.</p>
<p>This is similar to <a class="reference internal" href="#trio.testing.check_two_way_stream" title="trio.testing.check_two_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_two_way_stream()</span></code></a>, except that the maker
functions are expected to return objects that implement the
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.HalfCloseableStream" title="trio.abc.HalfCloseableStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">HalfCloseableStream</span></code></a> interface.</p>
<p>This function tests a <em>superset</em> of what <a class="reference internal" href="#trio.testing.check_two_way_stream" title="trio.testing.check_two_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_two_way_stream()</span></code></a>
checks – if you call this, then you don't need to also call
<a class="reference internal" href="#trio.testing.check_two_way_stream" title="trio.testing.check_two_way_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">check_two_way_stream()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

</div>
</div>
</section>
</section>
<section id="virtual-network-hooks">
<span id="id8"></span><h2>用于测试的虚拟网络<a class="headerlink" href="#virtual-network-hooks" title="Link to this heading">¶</a></h2>
<p><strong>Virtual networking for testing</strong></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>在前一节中，你学到了如何使用虚拟的内存流来测试基于 Trio 的 <a class="reference internal" href="ref-io/abs_api.html#trio.abc.Stream" title="trio.abc.Stream"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stream</span></code></a> 抽象编写的协议。但是，如果你有更复杂的网络代码——比如那种连接多个主机、打开监听套接字或发送 UDP 数据包的代码，该怎么办呢？</p>
<p>Trio 本身并没有提供用于测试的虚拟内存网络实现——但 <a class="reference internal" href="ref-io/low_level.html#module-trio.socket" title="trio.socket"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.socket</span></code></a> 模块提供了你需要的钩子，来让你自己编写！如果你有兴趣帮助实现一个可重用的虚拟网络用于测试， <a class="reference external" href="https://github.com/python-trio/trio/issues/170">请联系我们</a> 。</p>
<p>请注意，这些 API 实际上位于 <a class="reference internal" href="ref-io/low_level.html#module-trio.socket" title="trio.socket"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.socket</span></code></a> 和 <code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.abc</span></code> 中，但我们在这里文档化它们，因为它们主要用于测试。</p>
<dl class="py function">
<dt class="sig sig-object py" id="trio.socket.set_custom_hostname_resolver">
<span class="sig-prename descclassname"><span class="pre">trio.socket.</span></span><span class="sig-name descname"><span class="pre">set_custom_hostname_resolver</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">hostname_resolver</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.socket.set_custom_hostname_resolver" title="Link to this definition">¶</a></dt>
<dd><p>Set a custom hostname resolver.</p>
<p>By default, Trio's <a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getaddrinfo()</span></code></a> and <a class="reference internal" href="ref-io/low_level.html#trio.socket.getnameinfo" title="trio.socket.getnameinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getnameinfo()</span></code></a> functions
use the standard system resolver functions. This function allows you to
customize that behavior. The main intended use case is for testing, but it
might also be useful for using third-party resolvers like <a class="reference external" href="https://c-ares.haxx.se/">c-ares</a> (though be warned that these rarely make
perfect drop-in replacements for the system resolver). See
<a class="reference internal" href="#trio.abc.HostnameResolver" title="trio.abc.HostnameResolver"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.abc.HostnameResolver</span></code></a> for more details.</p>
<p>Setting a custom hostname resolver affects all future calls to
<a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getaddrinfo()</span></code></a> and <a class="reference internal" href="ref-io/low_level.html#trio.socket.getnameinfo" title="trio.socket.getnameinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getnameinfo()</span></code></a> within the enclosing call to
<a class="reference internal" href="ref-core/run.html#trio.run" title="trio.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.run()</span></code></a>. All other hostname resolution in Trio is implemented in
terms of these functions.</p>
<p>Generally you should call this function just once, right at the beginning
of your program.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>hostname_resolver</strong> (<a class="reference internal" href="#trio.abc.HostnameResolver" title="trio.abc.HostnameResolver"><em>trio.abc.HostnameResolver</em></a><em> or </em><em>None</em>) -- The new custom
hostname resolver, or None to restore the default behavior.</p>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type">HostnameResolver | None</span></p>
</dd>
<dt class="field-odd">返回<span class="colon">:</span></dt>
<dd class="field-odd"><p>The previous hostname resolver (which may be None).</p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="trio.abc.HostnameResolver">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.abc.</span></span><span class="sig-name descname"><span class="pre">HostnameResolver</span></span><a class="headerlink" href="#trio.abc.HostnameResolver" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference external" href="https://docs.python.org/zh-cn/3/library/abc.html#abc.ABC" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">ABC</span></code></a></p>
<p>If you have a custom hostname resolver, then implementing
<a class="reference internal" href="#trio.abc.HostnameResolver" title="trio.abc.HostnameResolver"><code class="xref py py-class docutils literal notranslate"><span class="pre">HostnameResolver</span></code></a> allows you to register this to be used by Trio.</p>
<p>See <a class="reference internal" href="#trio.socket.set_custom_hostname_resolver" title="trio.socket.set_custom_hostname_resolver"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.set_custom_hostname_resolver()</span></code></a>.</p>
<dl class="py method">
<dt class="sig sig-object py" id="trio.abc.HostnameResolver.getaddrinfo">
<em class="property"><span class="pre">abstractmethod</span> <span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">getaddrinfo</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">host</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">port</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">family</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">proto</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flags</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.abc.HostnameResolver.getaddrinfo" title="Link to this definition">¶</a></dt>
<dd><p>A custom implementation of <a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getaddrinfo()</span></code></a>.</p>
<p>Called by <a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.getaddrinfo()</span></code></a>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">host</span></code> is given as a numeric IP address, then
<a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getaddrinfo()</span></code></a> may handle the request itself rather
than calling this method.</p>
<p>Any required IDNA encoding is handled before calling this function;
your implementation can assume that it will never see U-labels like
<code class="docutils literal notranslate"><span class="pre">&quot;café.com&quot;</span></code>, and only needs to handle A-labels like
<code class="docutils literal notranslate"><span class="pre">b&quot;xn--caf-dma.com&quot;</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#list" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">list</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<code class="xref py py-class docutils literal notranslate"><span class="pre">AddressFamily</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">SocketKind</span></code>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>]]]</span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.abc.HostnameResolver.getnameinfo">
<em class="property"><span class="pre">abstractmethod</span> <span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">getnameinfo</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">sockaddr</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flags</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.abc.HostnameResolver.getnameinfo" title="Link to this definition">¶</a></dt>
<dd><p>A custom implementation of <a class="reference internal" href="ref-io/low_level.html#trio.socket.getnameinfo" title="trio.socket.getnameinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getnameinfo()</span></code></a>.</p>
<p>Called by <a class="reference internal" href="ref-io/low_level.html#trio.socket.getnameinfo" title="trio.socket.getnameinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.getnameinfo()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>]</span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.socket.set_custom_socket_factory">
<span class="sig-prename descclassname"><span class="pre">trio.socket.</span></span><span class="sig-name descname"><span class="pre">set_custom_socket_factory</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">socket_factory</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.socket.set_custom_socket_factory" title="Link to this definition">¶</a></dt>
<dd><p>Set a custom socket object factory.</p>
<p>This function allows you to replace Trio's normal socket class with a
custom class. This is very useful for testing, and probably a bad idea in
any other circumstance. See <a class="reference internal" href="#trio.abc.HostnameResolver" title="trio.abc.HostnameResolver"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.abc.HostnameResolver</span></code></a> for more
details.</p>
<p>Setting a custom socket factory affects all future calls to <a class="reference internal" href="ref-io/low_level.html#trio.socket.socket" title="trio.socket.socket"><code class="xref py py-func docutils literal notranslate"><span class="pre">socket()</span></code></a>
within the enclosing call to <a class="reference internal" href="ref-core/run.html#trio.run" title="trio.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.run()</span></code></a>.</p>
<p>Generally you should call this function just once, right at the beginning
of your program.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>socket_factory</strong> (<a class="reference internal" href="#trio.abc.SocketFactory" title="trio.abc.SocketFactory"><em>trio.abc.SocketFactory</em></a><em> or </em><em>None</em>) -- The new custom
socket factory, or None to restore the default behavior.</p>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type">SocketFactory | None</span></p>
</dd>
<dt class="field-odd">返回<span class="colon">:</span></dt>
<dd class="field-odd"><p>The previous socket factory (which may be None).</p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="trio.abc.SocketFactory">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.abc.</span></span><span class="sig-name descname"><span class="pre">SocketFactory</span></span><a class="headerlink" href="#trio.abc.SocketFactory" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference external" href="https://docs.python.org/zh-cn/3/library/abc.html#abc.ABC" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">ABC</span></code></a></p>
<p>If you write a custom class implementing the Trio socket interface,
then you can use a <a class="reference internal" href="#trio.abc.SocketFactory" title="trio.abc.SocketFactory"><code class="xref py py-class docutils literal notranslate"><span class="pre">SocketFactory</span></code></a> to get Trio to use it.</p>
<p>See <a class="reference internal" href="#trio.socket.set_custom_socket_factory" title="trio.socket.set_custom_socket_factory"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.set_custom_socket_factory()</span></code></a>.</p>
<dl class="py method">
<dt class="sig sig-object py" id="trio.abc.SocketFactory.socket">
<em class="property"><span class="pre">abstractmethod</span> </em><span class="sig-name descname"><span class="pre">socket</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">family</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">AddressFamily.AF_INET</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">SocketKind.SOCK_STREAM</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">proto</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.abc.SocketFactory.socket" title="Link to this definition">¶</a></dt>
<dd><p>Create and return a socket object.</p>
<p>Your socket object must inherit from <a class="reference internal" href="ref-io/low_level.html#trio.socket.SocketType" title="trio.socket.SocketType"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.socket.SocketType</span></code></a>,
which is an empty class whose only purpose is to &quot;mark&quot; which classes
should be considered valid Trio sockets.</p>
<p>Called by <a class="reference internal" href="ref-io/low_level.html#trio.socket.socket" title="trio.socket.socket"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.socket()</span></code></a>.</p>
<p>Note that unlike <a class="reference internal" href="ref-io/low_level.html#trio.socket.socket" title="trio.socket.socket"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.socket()</span></code></a>, this does not take a
<code class="docutils literal notranslate"><span class="pre">fileno=</span></code> argument. If a <code class="docutils literal notranslate"><span class="pre">fileno=</span></code> is specified, then
<a class="reference internal" href="ref-io/low_level.html#trio.socket.socket" title="trio.socket.socket"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.socket()</span></code></a> returns a regular Trio socket object
instead of calling this method.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type">SocketType</span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>In the previous section you learned how to use virtual in-memory
streams to test protocols that are written against Trio's
<a class="reference internal" href="ref-io/abs_api.html#trio.abc.Stream" title="trio.abc.Stream"><code class="xref py py-class docutils literal notranslate"><span class="pre">Stream</span></code></a> abstraction. But what if you have more
complicated networking code – the kind of code that makes connections
to multiple hosts, or opens a listening socket, or sends UDP packets?</p>
<p>Trio doesn't itself provide a virtual in-memory network implementation
for testing – but <a class="reference internal" href="ref-io/low_level.html#module-trio.socket" title="trio.socket"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.socket</span></code></a> module does provide the hooks you
need to write your own! And if you're interested in helping implement
a reusable virtual network for testing, then <a class="reference external" href="https://github.com/python-trio/trio/issues/170">please get in touch</a>.</p>
<p>Note that these APIs are actually in <a class="reference internal" href="ref-io/low_level.html#module-trio.socket" title="trio.socket"><code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.socket</span></code></a> and
<code class="xref py py-mod docutils literal notranslate"><span class="pre">trio.abc</span></code>, but we document them here because they're primarily
intended for testing.</p>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">trio.socket.</span></span><span class="sig-name descname"><span class="pre">set_custom_hostname_resolver</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">hostname_resolver</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Set a custom hostname resolver.</p>
<p>By default, Trio's <a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getaddrinfo()</span></code></a> and <a class="reference internal" href="ref-io/low_level.html#trio.socket.getnameinfo" title="trio.socket.getnameinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getnameinfo()</span></code></a> functions
use the standard system resolver functions. This function allows you to
customize that behavior. The main intended use case is for testing, but it
might also be useful for using third-party resolvers like <a class="reference external" href="https://c-ares.haxx.se/">c-ares</a> (though be warned that these rarely make
perfect drop-in replacements for the system resolver). See
<a class="reference internal" href="#trio.abc.HostnameResolver" title="trio.abc.HostnameResolver"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.abc.HostnameResolver</span></code></a> for more details.</p>
<p>Setting a custom hostname resolver affects all future calls to
<a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getaddrinfo()</span></code></a> and <a class="reference internal" href="ref-io/low_level.html#trio.socket.getnameinfo" title="trio.socket.getnameinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getnameinfo()</span></code></a> within the enclosing call to
<a class="reference internal" href="ref-core/run.html#trio.run" title="trio.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.run()</span></code></a>. All other hostname resolution in Trio is implemented in
terms of these functions.</p>
<p>Generally you should call this function just once, right at the beginning
of your program.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>hostname_resolver</strong> (<a class="reference internal" href="#trio.abc.HostnameResolver" title="trio.abc.HostnameResolver"><em>trio.abc.HostnameResolver</em></a><em> or </em><em>None</em>) -- The new custom
hostname resolver, or None to restore the default behavior.</p>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type">HostnameResolver | None</span></p>
</dd>
<dt class="field-odd">返回<span class="colon">:</span></dt>
<dd class="field-odd"><p>The previous hostname resolver (which may be None).</p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.abc.</span></span><span class="sig-name descname"><span class="pre">HostnameResolver</span></span></dt>
<dd><p>基类：<a class="reference external" href="https://docs.python.org/zh-cn/3/library/abc.html#abc.ABC" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">ABC</span></code></a></p>
<p>If you have a custom hostname resolver, then implementing
<a class="reference internal" href="#trio.abc.HostnameResolver" title="trio.abc.HostnameResolver"><code class="xref py py-class docutils literal notranslate"><span class="pre">HostnameResolver</span></code></a> allows you to register this to be used by Trio.</p>
<p>See <a class="reference internal" href="#trio.socket.set_custom_hostname_resolver" title="trio.socket.set_custom_hostname_resolver"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.set_custom_hostname_resolver()</span></code></a>.</p>
<dl class="py method">
<dt class="sig sig-object py">
<em class="property"><span class="pre">abstractmethod</span> <span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">getaddrinfo</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">host</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">port</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">family</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">proto</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flags</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>A custom implementation of <a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getaddrinfo()</span></code></a>.</p>
<p>Called by <a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.getaddrinfo()</span></code></a>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">host</span></code> is given as a numeric IP address, then
<a class="reference internal" href="ref-io/low_level.html#trio.socket.getaddrinfo" title="trio.socket.getaddrinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getaddrinfo()</span></code></a> may handle the request itself rather
than calling this method.</p>
<p>Any required IDNA encoding is handled before calling this function;
your implementation can assume that it will never see U-labels like
<code class="docutils literal notranslate"><span class="pre">&quot;café.com&quot;</span></code>, and only needs to handle A-labels like
<code class="docutils literal notranslate"><span class="pre">b&quot;xn--caf-dma.com&quot;</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#list" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">list</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<code class="xref py py-class docutils literal notranslate"><span class="pre">AddressFamily</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">SocketKind</span></code>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>] | <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#int" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a>]]]</span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<em class="property"><span class="pre">abstractmethod</span> <span class="pre">await</span> </em><span class="sig-name descname"><span class="pre">getnameinfo</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">sockaddr</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flags</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>A custom implementation of <a class="reference internal" href="ref-io/low_level.html#trio.socket.getnameinfo" title="trio.socket.getnameinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">getnameinfo()</span></code></a>.</p>
<p>Called by <a class="reference internal" href="ref-io/low_level.html#trio.socket.getnameinfo" title="trio.socket.getnameinfo"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.getnameinfo()</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#tuple" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">tuple</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#str" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">str</span></code></a>]</span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">trio.socket.</span></span><span class="sig-name descname"><span class="pre">set_custom_socket_factory</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">socket_factory</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Set a custom socket object factory.</p>
<p>This function allows you to replace Trio's normal socket class with a
custom class. This is very useful for testing, and probably a bad idea in
any other circumstance. See <a class="reference internal" href="#trio.abc.HostnameResolver" title="trio.abc.HostnameResolver"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.abc.HostnameResolver</span></code></a> for more
details.</p>
<p>Setting a custom socket factory affects all future calls to <a class="reference internal" href="ref-io/low_level.html#trio.socket.socket" title="trio.socket.socket"><code class="xref py py-func docutils literal notranslate"><span class="pre">socket()</span></code></a>
within the enclosing call to <a class="reference internal" href="ref-core/run.html#trio.run" title="trio.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.run()</span></code></a>.</p>
<p>Generally you should call this function just once, right at the beginning
of your program.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>socket_factory</strong> (<a class="reference internal" href="#trio.abc.SocketFactory" title="trio.abc.SocketFactory"><em>trio.abc.SocketFactory</em></a><em> or </em><em>None</em>) -- The new custom
socket factory, or None to restore the default behavior.</p>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type">SocketFactory | None</span></p>
</dd>
<dt class="field-odd">返回<span class="colon">:</span></dt>
<dd class="field-odd"><p>The previous socket factory (which may be None).</p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.abc.</span></span><span class="sig-name descname"><span class="pre">SocketFactory</span></span></dt>
<dd><p>基类：<a class="reference external" href="https://docs.python.org/zh-cn/3/library/abc.html#abc.ABC" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">ABC</span></code></a></p>
<p>If you write a custom class implementing the Trio socket interface,
then you can use a <a class="reference internal" href="#trio.abc.SocketFactory" title="trio.abc.SocketFactory"><code class="xref py py-class docutils literal notranslate"><span class="pre">SocketFactory</span></code></a> to get Trio to use it.</p>
<p>See <a class="reference internal" href="#trio.socket.set_custom_socket_factory" title="trio.socket.set_custom_socket_factory"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.set_custom_socket_factory()</span></code></a>.</p>
<dl class="py method">
<dt class="sig sig-object py">
<em class="property"><span class="pre">abstractmethod</span> </em><span class="sig-name descname"><span class="pre">socket</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">family</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">AddressFamily.AF_INET</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">SocketKind.SOCK_STREAM</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">proto</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Create and return a socket object.</p>
<p>Your socket object must inherit from <a class="reference internal" href="ref-io/low_level.html#trio.socket.SocketType" title="trio.socket.SocketType"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.socket.SocketType</span></code></a>,
which is an empty class whose only purpose is to &quot;mark&quot; which classes
should be considered valid Trio sockets.</p>
<p>Called by <a class="reference internal" href="ref-io/low_level.html#trio.socket.socket" title="trio.socket.socket"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.socket()</span></code></a>.</p>
<p>Note that unlike <a class="reference internal" href="ref-io/low_level.html#trio.socket.socket" title="trio.socket.socket"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.socket()</span></code></a>, this does not take a
<code class="docutils literal notranslate"><span class="pre">fileno=</span></code> argument. If a <code class="docutils literal notranslate"><span class="pre">fileno=</span></code> is specified, then
<a class="reference internal" href="ref-io/low_level.html#trio.socket.socket" title="trio.socket.socket"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.socket.socket()</span></code></a> returns a regular Trio socket object
instead of calling this method.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type">SocketType</span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
</div>
</section>
<section id="id9">
<h2>测试检查点<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h2>
<p><strong>Testing checkpoints</strong></p>
<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.assert_checkpoints">
<em class="property"><span class="pre">with</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">assert_checkpoints</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.assert_checkpoints" title="Link to this definition">¶</a></dt>
<dd><p>Use as a context manager to check that the code inside the <code class="docutils literal notranslate"><span class="pre">with</span></code>
block either exits with an exception or executes at least one
<a class="reference internal" href="ref-core/general_principles.html#checkpoints"><span class="std std-ref">checkpoint</span></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">抛出<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#AssertionError" title="（在 Python v3.13）"><strong>AssertionError</strong></a> -- if no checkpoint was executed.</p>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/contextlib.html#contextlib.AbstractContextManager" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractContextManager</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a>]</span></p>
</dd>
</dl>
<p class="rubric">示例</p>
<p>Check that <a class="reference internal" href="ref-core/time_clock.html#trio.sleep" title="trio.sleep"><code class="xref py py-func docutils literal notranslate"><span class="pre">trio.sleep()</span></code></a> is a checkpoint, even if it doesn't
block:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_checkpoints</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">trio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trio.testing.assert_no_checkpoints">
<em class="property"><span class="pre">with</span> </em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">assert_no_checkpoints</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.assert_no_checkpoints" title="Link to this definition">¶</a></dt>
<dd><p>Use as a context manager to check that the code inside the <code class="docutils literal notranslate"><span class="pre">with</span></code>
block does not execute any <a class="reference internal" href="ref-core/general_principles.html#checkpoints"><span class="std std-ref">checkpoints</span></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">抛出<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#AssertionError" title="（在 Python v3.13）"><strong>AssertionError</strong></a> -- if a checkpoint was executed.</p>
</dd>
<dt class="field-even">返回类型<span class="colon">:</span></dt>
<dd class="field-even"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/contextlib.html#contextlib.AbstractContextManager" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractContextManager</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a>]</span></p>
</dd>
</dl>
<p class="rubric">示例</p>
<p>Synchronous code never contains any checkpoints, but we can double-check
that:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">send_channel</span><span class="p">,</span> <span class="n">receive_channel</span> <span class="o">=</span> <span class="n">trio</span><span class="o">.</span><span class="n">open_memory_channel</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">with</span> <span class="n">trio</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_no_checkpoints</span><span class="p">():</span>
    <span class="n">send_channel</span><span class="o">.</span><span class="n">send_nowait</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="exceptiongroup">
<h2>ExceptionGroup 助手<a class="headerlink" href="#exceptiongroup" title="Link to this heading">¶</a></h2>
<p><strong>ExceptionGroup helpers</strong></p>
<dl class="py class">
<dt class="sig sig-object py" id="trio.testing.RaisesGroup">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">RaisesGroup</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">exception</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">other_exceptions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_unwrapped</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flatten_subgroups</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">match</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">check</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.RaisesGroup" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference external" href="https://docs.python.org/zh-cn/3/library/contextlib.html#contextlib.AbstractContextManager" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractContextManager</span></code></a>[<a class="reference internal" href="#trio.testing._raises_group._ExceptionInfo" title="trio.testing._raises_group._ExceptionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">_ExceptionInfo</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#BaseExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseExceptionGroup</span></code></a>[<a class="typevarref reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.TypeVar" title="TypeVar, （在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">E</span></code></a>]]], <a class="reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.Generic" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Generic</span></code></a>[<a class="typevarref reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.TypeVar" title="TypeVar, （在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">E</span></code></a>]</p>
<p>Contextmanager for checking for an expected <cite>ExceptionGroup</cite>.
This works similar to <code class="docutils literal notranslate"><span class="pre">pytest.raises</span></code>, and a version of it will hopefully be added upstream, after which this can be deprecated and removed. See <a class="reference external" href="https://github.com/pytest-dev/pytest/issues/11538">https://github.com/pytest-dev/pytest/issues/11538</a></p>
<p>The catching behaviour differs from <a class="reference external" href="https://docs.python.org/zh-cn/3/reference/compound_stmts.html#except-star" title="（在 Python v3.13）"><span class="xref std std-ref">except*</span></a> in multiple different ways, being much stricter by default. By using <code class="docutils literal notranslate"><span class="pre">allow_unwrapped=True</span></code> and <code class="docutils literal notranslate"><span class="pre">flatten_subgroups=True</span></code> you can match <code class="docutils literal notranslate"><span class="pre">except*</span></code> fully when expecting a single exception.</p>
<ol class="arabic simple">
<li><p>All specified exceptions must be present, <em>and no others</em>.</p>
<ul class="simple">
<li><p>If you expect a variable number of exceptions you need to use <code class="docutils literal notranslate"><span class="pre">pytest.raises(ExceptionGroup)</span></code> and manually check the contained exceptions. Consider making use of <a class="reference internal" href="#trio.testing.Matcher.matches" title="trio.testing.Matcher.matches"><code class="xref py py-func docutils literal notranslate"><span class="pre">Matcher.matches()</span></code></a>.</p></li>
</ul>
</li>
<li><p>It will only catch exceptions wrapped in an exceptiongroup by default.</p>
<ul class="simple">
<li><p>With <code class="docutils literal notranslate"><span class="pre">allow_unwrapped=True</span></code> you can specify a single expected exception or <cite>Matcher</cite> and it will match the exception even if it is not inside an <cite>ExceptionGroup</cite>. If you expect one of several different exception types you need to use a <cite>Matcher</cite> object.</p></li>
</ul>
</li>
<li><p>By default it cares about the full structure with nested <cite>ExceptionGroup</cite>'s. You can specify nested <cite>ExceptionGroup</cite>'s by passing <cite>RaisesGroup</cite> objects as expected exceptions.</p>
<ul class="simple">
<li><p>With <code class="docutils literal notranslate"><span class="pre">flatten_subgroups=True</span></code> it will &quot;flatten&quot; the raised <cite>ExceptionGroup</cite>, extracting all exceptions inside any nested <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a>, before matching.</p></li>
</ul>
</li>
</ol>
<p>It currently does not care about the order of the exceptions, so <code class="docutils literal notranslate"><span class="pre">RaisesGroups(ValueError,</span> <span class="pre">TypeError)</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">RaisesGroups(TypeError,</span> <span class="pre">ValueError)</span></code>.</p>
<p>This class is not as polished as <code class="docutils literal notranslate"><span class="pre">pytest.raises</span></code>, and is currently not as helpful in e.g. printing diffs when strings don't match, suggesting you use <code class="docutils literal notranslate"><span class="pre">re.escape</span></code>, etc.</p>
<p>Examples:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">ExceptionGroup</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">(),))</span>
<span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">Matcher</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;expected int&quot;</span><span class="p">)):</span>
    <span class="o">...</span>
<span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BaseExceptionGroup</span><span class="p">):</span>
    <span class="o">...</span>
<span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="n">RaisesGroups</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)):</span>
    <span class="k">raise</span> <span class="n">ExceptionGroup</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ExceptionGroup</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">(),)),))</span>

<span class="c1"># flatten_subgroups</span>
<span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">flatten_subgroups</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">ExceptionGroup</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ExceptionGroup</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">(),)),))</span>

<span class="c1"># allow_unwrapped</span>
<span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">allow_unwrapped</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span>
</pre></div>
</div>
<p><cite>RaisesGroup.matches</cite> can also be used directly to check a standalone exception group.</p>
<p>The matching algorithm is greedy, which means cases such as this may fail:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">Matcher</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">)):</span>
    <span class="k">raise</span> <span class="n">ExceptionGroup</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">),</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;goodbye&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<p>even though it generally does not care about the order of the exceptions in the group.
To avoid the above you should specify the first ValueError with a Matcher as well.</p>
<p>It is also not typechecked perfectly, and that's likely not possible with the current approach. Most common usage should work without issue though.</p>
<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.RaisesGroup.matches">
<span class="sig-name descname"><span class="pre">matches</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">exc_val</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.RaisesGroup.matches" title="Link to this definition">¶</a></dt>
<dd><p>Check if an exception matches the requirements of this RaisesGroup.</p>
<p>Example:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">excinfo</span><span class="p">:</span>
    <span class="o">...</span>
<span class="k">assert</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">__cause__</span><span class="p">)</span>
<span class="c1"># the above line is equivalent to</span>
<span class="n">myexc</span> <span class="o">=</span> <span class="n">excinfo</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">__cause</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">myexc</span><span class="p">,</span> <span class="n">BaseExceptionGroup</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">myexc</span><span class="o">.</span><span class="n">exceptions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">myexc</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">ValueError</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type">TypeGuard[BaseExceptionGroup[E]]</span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="trio.testing.Matcher">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.testing.</span></span><span class="sig-name descname"><span class="pre">Matcher</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">exception_type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">match</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">check</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.Matcher" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.Generic" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Generic</span></code></a>[<a class="typevarref reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.TypeVar" title="TypeVar, （在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">MatchE</span></code></a>]</p>
<p>Helper class to be used together with RaisesGroups when you want to specify requirements on sub-exceptions. Only specifying the type is redundant, and it's also unnecessary when the type is a nested <cite>RaisesGroup</cite> since it supports the same arguments.
The type is checked with <cite>isinstance</cite>, and does not need to be an exact match. If that is wanted you can use the <code class="docutils literal notranslate"><span class="pre">check</span></code> parameter.
<a class="reference internal" href="#trio.testing.Matcher.matches" title="trio.testing.Matcher.matches"><code class="xref py py-meth docutils literal notranslate"><span class="pre">trio.testing.Matcher.matches()</span></code></a> can also be used standalone to check individual exceptions.</p>
<p>Examples:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="n">Matcher</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">))</span>
    <span class="o">...</span>
<span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="n">Matcher</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">))):</span>
    <span class="o">...</span>
<span class="k">with</span> <span class="n">RaisesGroups</span><span class="p">(</span><span class="n">Matcher</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="ne">ValueError</span><span class="p">)):</span>
    <span class="o">...</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="trio.testing.Matcher.matches">
<span class="sig-name descname"><span class="pre">matches</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">exception</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing.Matcher.matches" title="Link to this definition">¶</a></dt>
<dd><p>Check if an exception matches the requirements of this Matcher.</p>
<p>Examples:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">Matcher</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">my_exception</span><span class="p">):</span>
<span class="c1"># is equivalent to</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">my_exception</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span>

<span class="c1"># this can be useful when checking e.g. the ``__cause__`` of an exception.</span>
<span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">excinfo</span><span class="p">:</span>
    <span class="o">...</span>
<span class="k">assert</span> <span class="n">Matcher</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">__cause__</span><span class="p">)</span>
<span class="c1"># above line is equivalent to</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">__cause__</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">__cause__</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type">TypeGuard[MatchE]</span></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="trio.testing._raises_group._ExceptionInfo">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">trio.testing._raises_group.</span></span><span class="sig-name descname"><span class="pre">_ExceptionInfo</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">excinfo</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing._raises_group._ExceptionInfo" title="Link to this definition">¶</a></dt>
<dd><p>基类：<a class="reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.Generic" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Generic</span></code></a>[<a class="typevarref reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.TypeVar" title="TypeVar, （在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">MatchE</span></code></a>]</p>
<p>Minimal re-implementation of pytest.ExceptionInfo, only used if pytest is not available. Supports a subset of its features necessary for functionality of <a class="reference internal" href="#trio.testing.RaisesGroup" title="trio.testing.RaisesGroup"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.testing.RaisesGroup</span></code></a> and <a class="reference internal" href="#trio.testing.Matcher" title="trio.testing.Matcher"><code class="xref py py-class docutils literal notranslate"><span class="pre">trio.testing.Matcher</span></code></a>.</p>
<dl class="py method">
<dt class="sig sig-object py" id="trio.testing._raises_group._ExceptionInfo.fill_unfilled">
<span class="sig-name descname"><span class="pre">fill_unfilled</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">exc_info</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing._raises_group._ExceptionInfo.fill_unfilled" title="Link to this definition">¶</a></dt>
<dd><p>Fill an unfilled ExceptionInfo created with <code class="docutils literal notranslate"><span class="pre">for_later()</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference external" href="https://docs.python.org/zh-cn/3/library/constants.html#None" title="（在 Python v3.13）"><code class="xref py py-obj docutils literal notranslate"><span class="pre">None</span></code></a></span></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trio.testing._raises_group._ExceptionInfo.for_later">
<em class="property"><span class="pre">classmethod</span> </em><span class="sig-name descname"><span class="pre">for_later</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#trio.testing._raises_group._ExceptionInfo.for_later" title="Link to this definition">¶</a></dt>
<dd><p>Return an unfilled ExceptionInfo.</p>
<dl class="field-list simple">
<dt class="field-odd">返回类型<span class="colon">:</span></dt>
<dd class="field-odd"><p><span class="sphinx_autodoc_typehints-type"><a class="reference internal" href="#trio.testing._raises_group._ExceptionInfo" title="trio.testing._raises_group._ExceptionInfo"><code class="xref py py-class docutils literal notranslate"><span class="pre">_ExceptionInfo</span></code></a>[<a class="reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.TypeVar" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeVar</span></code></a>(<code class="docutils literal notranslate"><span class="pre">MatchE</span></code>, bound= <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#BaseException" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseException</span></code></a>, covariant=True)]</span></p>
</dd>
</dl>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py" id="trio.testing._raises_group._ExceptionInfo.type">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">type</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#type" title="（在 Python v3.13）"><span class="pre">type</span></a><span class="p"><span class="pre">[</span></span><a class="typevarref reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.TypeVar" title="TypeVar, （在 Python v3.13）"><span class="pre">MatchE</span></a><span class="p"><span class="pre">]</span></span></em><a class="headerlink" href="#trio.testing._raises_group._ExceptionInfo.type" title="Link to this definition">¶</a></dt>
<dd><p>The exception class.</p>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py" id="trio.testing._raises_group._ExceptionInfo.value">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">value</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="typevarref reference external" href="https://docs.python.org/zh-cn/3/library/typing.html#typing.TypeVar" title="TypeVar, （在 Python v3.13）"><span class="pre">MatchE</span></a></em><a class="headerlink" href="#trio.testing._raises_group._ExceptionInfo.value" title="Link to this definition">¶</a></dt>
<dd><p>The exception value.</p>
</dd></dl>

<dl class="py property">
<dt class="sig sig-object py" id="trio.testing._raises_group._ExceptionInfo.tb">
<em class="property"><span class="pre">property</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">tb</span></span><em class="property"><span class="p"><span class="pre">:</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/zh-cn/3/library/types.html#types.TracebackType" title="（在 Python v3.13）"><span class="pre">TracebackType</span></a></em><a class="headerlink" href="#trio.testing._raises_group._ExceptionInfo.tb" title="Link to this definition">¶</a></dt>
<dd><p>The exception raw traceback.</p>
</dd></dl>

</dd></dl>

</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="reference-lowlevel.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">自省和扩展 Trio</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="ref-io/signals.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">信号</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2017, Nathaniel J. Smith
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/hellowac/trio-zh-cn" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Trio 中的测试</a><ul>
<li><a class="reference internal" href="#id1">测试工具集成</a><ul>
<li><a class="reference internal" href="#trio.testing.trio_test"><code class="docutils literal notranslate"><span class="pre">trio_test</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-time">时间和超时</a><ul>
<li><a class="reference internal" href="#trio.testing.MockClock"><code class="docutils literal notranslate"><span class="pre">MockClock</span></code></a><ul>
<li><a class="reference internal" href="#trio.testing.MockClock.rate"><code class="docutils literal notranslate"><span class="pre">MockClock.rate</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MockClock.autojump_threshold"><code class="docutils literal notranslate"><span class="pre">MockClock.autojump_threshold</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MockClock.jump"><code class="docutils literal notranslate"><span class="pre">MockClock.jump()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id3">任务排序</a><ul>
<li><a class="reference internal" href="#trio.testing.Sequencer"><code class="docutils literal notranslate"><span class="pre">Sequencer</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.wait_all_tasks_blocked"><code class="docutils literal notranslate"><span class="pre">wait_all_tasks_blocked()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.wait_all_threads_completed"><code class="docutils literal notranslate"><span class="pre">wait_all_threads_completed()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.active_thread_count"><code class="docutils literal notranslate"><span class="pre">active_thread_count()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-streams">流</a><ul>
<li><a class="reference internal" href="#id5">连接到进程内套接字服务器</a><ul>
<li><a class="reference internal" href="#trio.testing.open_stream_to_socket_listener"><code class="docutils literal notranslate"><span class="pre">open_stream_to_socket_listener()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#virtual-streams">虚拟、可控流</a></li>
<li><a class="reference internal" href="#api">API 详细信息</a><ul>
<li><a class="reference internal" href="#trio.testing.MemorySendStream"><code class="docutils literal notranslate"><span class="pre">MemorySendStream</span></code></a><ul>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.send_all_hook"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.send_all_hook</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.wait_send_all_might_not_block_hook"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.wait_send_all_might_not_block_hook</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.close_hook"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.close_hook</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.aclose"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.aclose()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.close"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.close()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.get_data"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.get_data()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.get_data_nowait"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.get_data_nowait()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.send_all"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.send_all()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemorySendStream.wait_send_all_might_not_block"><code class="docutils literal notranslate"><span class="pre">MemorySendStream.wait_send_all_might_not_block()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#trio.testing.MemoryReceiveStream"><code class="docutils literal notranslate"><span class="pre">MemoryReceiveStream</span></code></a><ul>
<li><a class="reference internal" href="#trio.testing.MemoryReceiveStream.receive_some_hook"><code class="docutils literal notranslate"><span class="pre">MemoryReceiveStream.receive_some_hook</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemoryReceiveStream.close_hook"><code class="docutils literal notranslate"><span class="pre">MemoryReceiveStream.close_hook</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemoryReceiveStream.aclose"><code class="docutils literal notranslate"><span class="pre">MemoryReceiveStream.aclose()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemoryReceiveStream.close"><code class="docutils literal notranslate"><span class="pre">MemoryReceiveStream.close()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemoryReceiveStream.put_data"><code class="docutils literal notranslate"><span class="pre">MemoryReceiveStream.put_data()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemoryReceiveStream.put_eof"><code class="docutils literal notranslate"><span class="pre">MemoryReceiveStream.put_eof()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.MemoryReceiveStream.receive_some"><code class="docutils literal notranslate"><span class="pre">MemoryReceiveStream.receive_some()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#trio.testing.memory_stream_pump"><code class="docutils literal notranslate"><span class="pre">memory_stream_pump()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.memory_stream_one_way_pair"><code class="docutils literal notranslate"><span class="pre">memory_stream_one_way_pair()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.memory_stream_pair"><code class="docutils literal notranslate"><span class="pre">memory_stream_pair()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.lockstep_stream_one_way_pair"><code class="docutils literal notranslate"><span class="pre">lockstep_stream_one_way_pair()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.lockstep_stream_pair"><code class="docutils literal notranslate"><span class="pre">lockstep_stream_pair()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#testing-custom-streams">测试自定义流实现</a><ul>
<li><a class="reference internal" href="#trio.testing.check_one_way_stream"><code class="docutils literal notranslate"><span class="pre">check_one_way_stream()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.check_two_way_stream"><code class="docutils literal notranslate"><span class="pre">check_two_way_stream()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.check_half_closeable_stream"><code class="docutils literal notranslate"><span class="pre">check_half_closeable_stream()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#virtual-network-hooks">用于测试的虚拟网络</a><ul>
<li><a class="reference internal" href="#trio.socket.set_custom_hostname_resolver"><code class="docutils literal notranslate"><span class="pre">set_custom_hostname_resolver()</span></code></a></li>
<li><a class="reference internal" href="#trio.abc.HostnameResolver"><code class="docutils literal notranslate"><span class="pre">HostnameResolver</span></code></a><ul>
<li><a class="reference internal" href="#trio.abc.HostnameResolver.getaddrinfo"><code class="docutils literal notranslate"><span class="pre">HostnameResolver.getaddrinfo()</span></code></a></li>
<li><a class="reference internal" href="#trio.abc.HostnameResolver.getnameinfo"><code class="docutils literal notranslate"><span class="pre">HostnameResolver.getnameinfo()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#trio.socket.set_custom_socket_factory"><code class="docutils literal notranslate"><span class="pre">set_custom_socket_factory()</span></code></a></li>
<li><a class="reference internal" href="#trio.abc.SocketFactory"><code class="docutils literal notranslate"><span class="pre">SocketFactory</span></code></a><ul>
<li><a class="reference internal" href="#trio.abc.SocketFactory.socket"><code class="docutils literal notranslate"><span class="pre">SocketFactory.socket()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id9">测试检查点</a><ul>
<li><a class="reference internal" href="#trio.testing.assert_checkpoints"><code class="docutils literal notranslate"><span class="pre">assert_checkpoints()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing.assert_no_checkpoints"><code class="docutils literal notranslate"><span class="pre">assert_no_checkpoints()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#exceptiongroup">ExceptionGroup 助手</a><ul>
<li><a class="reference internal" href="#trio.testing.RaisesGroup"><code class="docutils literal notranslate"><span class="pre">RaisesGroup</span></code></a><ul>
<li><a class="reference internal" href="#trio.testing.RaisesGroup.matches"><code class="docutils literal notranslate"><span class="pre">RaisesGroup.matches()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#trio.testing.Matcher"><code class="docutils literal notranslate"><span class="pre">Matcher</span></code></a><ul>
<li><a class="reference internal" href="#trio.testing.Matcher.matches"><code class="docutils literal notranslate"><span class="pre">Matcher.matches()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#trio.testing._raises_group._ExceptionInfo"><code class="docutils literal notranslate"><span class="pre">_ExceptionInfo</span></code></a><ul>
<li><a class="reference internal" href="#trio.testing._raises_group._ExceptionInfo.fill_unfilled"><code class="docutils literal notranslate"><span class="pre">_ExceptionInfo.fill_unfilled()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing._raises_group._ExceptionInfo.for_later"><code class="docutils literal notranslate"><span class="pre">_ExceptionInfo.for_later()</span></code></a></li>
<li><a class="reference internal" href="#trio.testing._raises_group._ExceptionInfo.type"><code class="docutils literal notranslate"><span class="pre">_ExceptionInfo.type</span></code></a></li>
<li><a class="reference internal" href="#trio.testing._raises_group._ExceptionInfo.value"><code class="docutils literal notranslate"><span class="pre">_ExceptionInfo.value</span></code></a></li>
<li><a class="reference internal" href="#trio.testing._raises_group._ExceptionInfo.tb"><code class="docutils literal notranslate"><span class="pre">_ExceptionInfo.tb</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=d2451d57"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/tabs.js?v=3ee01567"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    </body>
</html>